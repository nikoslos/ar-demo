<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>&lt;model-viewer&gt; annotation test</title>
    <meta content="&lt;model-viewer&gt; annotation test">
    <meta charset="utf-8">
    <link type="text/css" href="style/styles.css" rel="stylesheet">
    <link type="text/css" href="style/customStyle.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@next"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Modelviewer Demo</title>
</head>

<body>
    <div id="mvapp" style="width:100%;height:100%;">
        <!-- Model-Viewer Settings -->
        <model-viewer ref="modelviewer" bounds="tight" alt="Model-Viewer Raycast Annotation Test"
            src="models/Brachiopode.glb" ar="" ar-modes="webxr scene-viewer quick-look" camera-controls=""
            poster="res/poster.png" seamless-poster="" shadow-intensity="5.3" shadow-softness="1"
            ar-status="not-presenting">

            <!-- AR Overlays -->
            <button slot="ar-button" id="ar-button">
                View in your space
            </button>

            <div id="ar-prompt">
                <img src="res/ar_hand_prompt.png">
            </div>

            <button id="ar-failure">
                AR is not tracking!
            </button>

            <button v-for="(annotation, index) in annotations" :key="annotation.name"
                :class="{Hotspot:true,hidden:!annotation.visible}" :slot="annotation.name"
                :data-position="annotation.position" :data-normal="annotation.normal">
                <div class="HotspotAnnotation">{{annotation.text}}</div>
            </button>


            <div class="ui">
                <h1>Annotations</h1>
                <div v-for="(annotation, index) in annotations" :key="annotation.name" class="input-group mb-2">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0" type="checkbox" v-model="annotation.visible"
                            :aria-label="annotation.name">
                    </div>
                    <input type="text" v-model="annotation.text" :aria-label="annotation.name">
                    <button @click="removeAnnotation(index)" class="btn btn-outline-danger" type="button">Remove</button>
                </div>
            </div>

        </model-viewer>
    </div>
    <!-- Loads <model-viewer> for browsers: -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <!-- <script src="/script.js"></script>-->

    <script>
        const anapp = {
            data() {
                return {
                    annotations: [
                        {
                            name: "hotspot-1",
                            position: "0.4396451917578843m 0.03839100798010142m -0.00967103187458726m",
                            normal: "0m 0.9999999999999911m 1.3435883843274954e-7m",
                            text: "Ort 1",
                            visible: true,
                        },
                        {
                            name: "hotspot-2",
                            position: "-0.012901197430585043m 0.2881207060197228m 0.5770391929783498m",
                            normal: "-0.4621689753094269m 0.08027424053505347m 0.8831511108343548m",
                            text: "Ort 2",
                            visible: true,
                        },
                        {
                            name: "hotspot-3",
                            position: "0.02534048213197737m 0.004948022658037232m -0.6912640659255601m",
                            normal: "0m 1.3435883843274954e-7m -0.9999999999999911m",
                            text: "Ort 3",
                            visible: true
                        },
                        {
                            name: "hotspot-4",
                            position: "0.4202370633436088m 0.396150592746189m 0.4017215489638858m",
                            normal: "0m 0m -1m",
                            text: "From Other App",
                            visible: true
                        }
                    ],
                    lastAnnotationIndex: 4,
                    selectedAnnotations: [],
                    mouseMoved: false,
                    pressed: false,
                    panning: false,
                    modelViewer: undefined,
                    panX: undefined,
                    panY: undefined,
                    metersPerPixel: undefined,
                    startX: undefined,
                    startY: undefined,
                    lastX: undefined,
                    lastY: undefined
                }
            },
            methods: {
                handleButtonClick() {
                    this.annotations[1].text = 'Neuer Text'
                },
                removeAnnotation(index) {
                    this.annotations.splice(index, 1);
                },
                startPan() {
                    const orbit = this.modelViewer.getCameraOrbit();
                    const { theta, phi, radius } = orbit;
                    const psi = theta - this.modelViewer.turntableRotation;
                    this.metersPerPixel = 0.75 * radius / this.modelViewer.getBoundingClientRect().height;
                    this.panX = [-Math.cos(psi), 0, Math.sin(psi)];
                    this.panY = [
                        -Math.cos(phi) * Math.sin(psi),
                        Math.sin(phi),
                        -Math.cos(phi) * Math.cos(psi)
                    ];
                    this.modelViewer.interactionPrompt = 'none';
                },
                movePan(thisX, thisY) {
                    const dx = (thisX - this.lastX) * this.metersPerPixel;
                    const dy = (thisY - this.lastY) * this.metersPerPixel;
                    this.lastX = thisX;
                    this.lastY = thisY;

                    const target = this.modelViewer.getCameraTarget();
                    target.x += dx * this.panX[0] + dy * this.panY[0];
                    target.y += dx * this.panX[1] + dy * this.panY[1];
                    target.z += dx * this.panX[2] + dy * this.panY[2];
                    this.modelViewer.cameraTarget = `${target.x}m ${target.y}m ${target.z}m`;
                },
                hitAddAnnotation(event) {
                    const hit = this.$refs.modelviewer.positionAndNormalFromPoint(event.clientX, event.clientY);
                    if (hit != null) {
                        var annotationIndex = this.lastAnnotationIndex + 1
                        var name = `hotspot-${annotationIndex}`;
                        var position = hit.position.toString();
                        var normal = hit.normal.toString()
                        var text = `Annotation ${annotationIndex}`
                        this.annotations.push({ name, position, normal, text, visible: true })
                        this.lastAnnotationIndex++; // Shouldn't be done here
                    }
                },
                handleMouseDown(event) {
                    this.pressed = true;
                    this.startX = event.clientX;
                    this.startY = event.clientY;
                    this.panning = event.button === 2 || event.ctrlKey || event.metaKey ||
                        event.shiftKey;
                    if (!this.panning)
                        return;
                    this.lastX = this.startX;
                    this.lastY = this.startY;
                    this.startPan()
                    event.stopPropagation();
                },
                handleMouseMove(event) {
                    if (!this.mouseMoved && this.pressed) {
                        this.mouseMoved = true;
                    }
                    if (!this.panning) return;
                    this.movePan(event.clientX, event.clientY);
                    event.stopPropagation();
                },
                handleMouseUp(event) {
                    if (!this.mouseMoved && !this.panning) {
                        this.hitAddAnnotation(event);
                    }
                    this.mouseMoved = false;
                    this.pressed = false;
                    this.panning = false;
                },
                handleTouchStart(event) {
                    const { targetTouches, touches } = event;
                    this.startX = targetTouches[0].clientX;
                    this.startY = targetTouches[0].clientY;
                    this.panning = targetTouches.length === 2 && targetTouches.length === touches.length;
                    if (!this.panning)
                        return;

                    this.lastX = 0.5 * (targetTouches[0].clientX + targetTouches[1].clientX);
                    this.lastY = 0.5 * (targetTouches[0].clientY + targetTouches[1].clientY);
                    this.startPan();
                },
                handleTouchMove(event) {
                    console.log("Touchmove");

                    if (!this.panning || event.targetTouches.length !== 2)
                        return;
                    const { targetTouches } = event;
                    const thisX = 0.5 * (targetTouches[0].clientX + targetTouches[1].clientX);
                    const thisY = 0.5 * (targetTouches[0].clientY + targetTouches[1].clientY);
                    this.movePan(thisX, thisY);

                },
                handleTouchEnd(event) {
                    if (event.targetTouches.length === 0) {
                        this.hitAddAnnotation(event.changedTouches[0]);
                    }
                    this.mouseMoved = false;
                    this.pressed = false;
                    this.panning = false;
                }
            },
            mounted() {
                this.modelViewer = this.$refs.modelviewer;

                self.addEventListener('mousedown', this.handleMouseDown, true);
                self.addEventListener('mousemove', this.handleMouseMove, true);
                self.addEventListener('mouseup', this.handleMouseUp, true)

                this.modelViewer.addEventListener("touchstart", this.handleTouchStart, true);
                this.modelViewer.addEventListener("touchmove", this.handleTouchMove, true);
                this.modelViewer.addEventListener("touchend", this.handleTouchEnd, true);
            }
        }

        app = Vue.createApp(anapp)

        app.config.compilerOptions.isCustomElement = tag => tag.startsWith('model-viewer')

        app.mount("#mvapp")


    </script>

</body>

</html>